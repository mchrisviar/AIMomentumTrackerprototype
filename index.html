<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Momentum</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0d0f14;
      --surface:   #161b26;
      --border:    #252d3d;
      --text:      #e2e8f0;
      --muted:     #64748b;
      --green:     #22c55e;
      --red:       #ef4444;
      --red-dim:   #7f1d1d;
      --accent:    #3b82f6;
      --accent-h:  #2563eb;
      --gold:      #f59e0b;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      padding: 2rem 1rem 3rem;
    }

    /* ── Header ── */
    header {
      max-width: 900px;
      margin: 0 auto 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      background: linear-gradient(135deg, #e2e8f0 0%, #94a3b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    #as-of {
      font-size: 0.8rem;
      color: var(--muted);
    }

    #refresh-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.45rem 1rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }
    #refresh-btn:hover   { background: var(--accent-h); }
    #refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    #refresh-btn svg { width: 14px; height: 14px; }
    #refresh-btn.spinning svg { animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Error banner ── */
    #error-msg {
      max-width: 900px;
      margin: 0 auto 1.5rem;
      background: rgba(239,68,68,0.1);
      border: 1px solid var(--red-dim);
      color: var(--red);
      border-radius: 10px;
      padding: 1rem 1.25rem;
      font-size: 0.9rem;
      display: none;
      align-items: flex-start;
      gap: 0.6rem;
    }
    #error-msg.visible { display: flex; }

    /* ── Movers grid ── */
    .movers-grid {
      max-width: 900px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    /* ── Analysis sections ── */
    .analysis-sections {
      max-width: 900px;
      margin: 1.5rem auto 0;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    /* ── Card ── */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }

    .card-header {
      padding: 1rem 1.25rem 0.75rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-header h2 {
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .dot { width: 8px; height: 8px; border-radius: 50%; }
    .dot-green  { background: var(--green); }
    .dot-red    { background: var(--red); }
    .dot-blue   { background: var(--accent); }
    .dot-gold   { background: var(--gold); }

    /* ── Movers table ── */
    table { width: 100%; border-collapse: collapse; }

    thead th {
      padding: 0.6rem 1.25rem;
      text-align: left;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
    }
    thead th:last-child { text-align: right; }

    tbody tr { border-top: 1px solid var(--border); transition: background 0.1s; }
    tbody tr:hover { background: rgba(255,255,255,0.03); }

    tbody td { padding: 0.75rem 1.25rem; font-size: 0.9rem; }

    .symbol { font-weight: 700; letter-spacing: 0.04em; }
    .price  { color: var(--muted); font-variant-numeric: tabular-nums; }

    .pct-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }
    .positive { color: var(--green); background: rgba(34,197,94,0.1); }
    .negative { color: var(--red);   background: rgba(239,68,68,0.1); }

    .empty-row td {
      text-align: center;
      color: var(--muted);
      padding: 2rem 1.25rem;
      font-size: 0.85rem;
    }

    /* ── Prose (markdown) ── */
    .prose {
      padding: 1.5rem 1.25rem;
      font-size: 0.88rem;
      line-height: 1.75;
      color: #cbd5e1;
    }

    .prose p { margin-bottom: 0.8rem; }
    .prose p:last-child { margin-bottom: 0; }

    .prose .ph1,
    .prose .ph2 {
      color: var(--text);
      font-weight: 700;
      margin: 1.25rem 0 0.5rem;
      font-size: 1rem;
      letter-spacing: -0.01em;
    }
    .prose .ph3 {
      color: #94a3b8;
      font-weight: 600;
      margin: 1rem 0 0.4rem;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .prose .ph4 {
      color: #94a3b8;
      font-weight: 600;
      margin: 0.75rem 0 0.3rem;
      font-size: 0.88rem;
    }

    .prose ul {
      padding-left: 1.4rem;
      margin-bottom: 0.8rem;
    }
    .prose ul li { margin-bottom: 0.35rem; }

    .prose hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 1.25rem 0;
    }

    .prose strong { color: #f1f5f9; font-weight: 600; }
    .prose em     { font-style: italic; color: #94a3b8; }

    .prose code {
      background: rgba(255,255,255,0.07);
      padding: 0.1em 0.35em;
      border-radius: 4px;
      font-family: 'Cascadia Code', 'Consolas', monospace;
      font-size: 0.82em;
      color: #93c5fd;
    }

    /* Prose table */
    .prose .md-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      font-size: 0.85rem;
    }
    .prose .md-table th,
    .prose .md-table td {
      padding: 0.55rem 0.85rem;
      border: 1px solid var(--border);
      text-align: left;
    }
    .prose .md-table th {
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.72rem;
      letter-spacing: 0.05em;
    }
    .prose .md-table tr:hover td { background: rgba(255,255,255,0.02); }

    .prose-loading {
      text-align: center;
      color: var(--muted);
      padding: 2.5rem 1.25rem;
      font-size: 0.85rem;
    }

    /* ── Countdown ── */
    .countdown {
      text-align: center;
      font-size: 0.72rem;
      color: var(--muted);
      margin-top: 1.25rem;
      letter-spacing: 0.02em;
    }

    /* ── Responsive ── */
    @media (max-width: 600px) {
      .movers-grid { grid-template-columns: 1fr; }
      h1 { font-size: 1.4rem; }
    }
  </style>
</head>
<body>

  <header>
    <h1>Momentum</h1>
    <p>THIS IS NOT INVESTMENT ADVICE ONLY. IT IS AN AI MOMEMNTUM TRACKER PROTOTYPE.FOR EUDUCATIONAL PURPOSES ONLY</p>
    <div class="header-right">
      <span id="as-of"></span>
      <button id="refresh-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
             stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
          <path d="M21 3v5h-5"/>
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
          <path d="M3 21v-5h5"/>
        </svg>
        Refresh
      </button>
    </div>
  </header>

  <div id="error-msg" role="alert">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
         style="flex-shrink:0;margin-top:1px">
      <circle cx="12" cy="12" r="10"/>
      <line x1="12" y1="8" x2="12" y2="12"/>
      <line x1="12" y1="16" x2="12.01" y2="16"/>
    </svg>
    <span id="error-text">Could not load data.</span>
  </div>

  <!-- Movers -->
  <div class="movers-grid">
    <div class="card">
      <div class="card-header">
        <span class="dot dot-green"></span>
        <h2>Top Gainers</h2>
      </div>
      <table>
        <thead><tr><th>Symbol</th><th>Price</th><th>Change</th></tr></thead>
        <tbody id="gainers-body">
          <tr class="empty-row"><td colspan="3">Loading&hellip;</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="dot dot-red"></span>
        <h2>Top Losers</h2>
      </div>
      <table>
        <thead><tr><th>Symbol</th><th>Price</th><th>Change</th></tr></thead>
        <tbody id="losers-body">
          <tr class="empty-row"><td colspan="3">Loading&hellip;</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Analysis sections -->
  <div class="analysis-sections">

    <div class="card">
      <div class="card-header">
        <span class="dot dot-blue"></span>
        <h2>Market Analysis</h2>
      </div>
      <div id="market-analysis" class="prose">
        <p class="prose-loading">Loading&hellip;</p>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="dot dot-gold"></span>
        <h2>Created Portfolio</h2>
      </div>
      <div id="portfolio-analysis" class="prose">
        <p class="prose-loading">Loading&hellip;</p>
      </div>
    </div>

  </div>

  <p class="countdown" id="countdown"></p>
 <div style = "display: flex; justify-content: center; align-items: center; height: 50px;"> <p>THIS IS NOT INVESTMENT ADVICE ONLY. IT IS AN AI MOMEMNTUM TRACKER PROTOTYPE. FOR EUDUCATIONAL PURPOSES ONLY</p>  </div>
  <script>
    const WEBHOOK = 'https://michaelfinance.app.n8n.cloud/webhook/dailymoversandlosers';
    const INTERVAL = 5 * 60 * 1000;

    const gainersBody     = document.getElementById('gainers-body');
    const losersBody      = document.getElementById('losers-body');
    const marketAnalysis  = document.getElementById('market-analysis');
    const portfolioEl     = document.getElementById('portfolio-analysis');
    const asOfEl          = document.getElementById('as-of');
    const errorEl         = document.getElementById('error-msg');
    const errorText       = document.getElementById('error-text');
    const refreshBtn      = document.getElementById('refresh-btn');
    const countdownEl     = document.getElementById('countdown');

    let nextRefresh = Date.now() + INTERVAL;

    /* ── Helpers ── */
    function formatDate(iso) {
      try {
        return new Date(iso).toLocaleString(undefined, {
          weekday: 'short', month: 'short', day: 'numeric',
          year: 'numeric', hour: '2-digit', minute: '2-digit',
          timeZoneName: 'short'
        });
      } catch { return iso; }
    }

    function formatPrice(n) {
      return '$' + Number(n).toLocaleString(undefined, {
        minimumFractionDigits: 2, maximumFractionDigits: 2
      });
    }

    function formatPct(n) {
      const sign = n >= 0 ? '+' : '';
      return sign + Number(n).toFixed(3) + '%';
    }

    function escHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function buildMoverRows(data, isPositive) {
      if (!data || !data.length)
        return '<tr class="empty-row"><td colspan="3">No data available</td></tr>';
      return data.map(row => {
        const cls = isPositive ? 'positive' : 'negative';
        return `<tr>
          <td class="symbol">${escHtml(row.symbol)}</td>
          <td class="price">${formatPrice(row.current)}</td>
          <td style="text-align:right"><span class="pct-badge ${cls}">${formatPct(row.percentagechange)}</span></td>
        </tr>`;
      }).join('');
    }

    /* ── Minimal Markdown renderer ── */
    function inlineMd(text) {
      return escHtml(text)
        .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.*?)\*\*/g,     '<strong>$1</strong>')
        .replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>')
        .replace(/`([^`]+)`/g,         '<code>$1</code>');
    }

    function renderMarkdown(raw) {
      if (!raw || !raw.trim())
        return '<p class="prose-loading">No analysis available.</p>';

      const lines = raw.split('\n');
      let html = '';
      let inUl    = false;
      let inTable = false;
      let tablePassedHeader = false;

      function closeUl()    { if (inUl)    { html += '</ul>'; inUl = false; } }
      function closeTable() {
        if (inTable) {
          html += '</tbody></table>';
          inTable = false;
          tablePassedHeader = false;
        }
      }

      for (let i = 0; i < lines.length; i++) {
        const raw   = lines[i];
        const trim  = raw.trim();
        const depth = raw.search(/\S/);   // indentation level

        /* Horizontal rule */
        if (/^---+$/.test(trim)) {
          closeUl(); closeTable();
          html += '<hr>';
          continue;
        }

        /* Headings */
        const hm = trim.match(/^(#{1,4})\s+(.*)/);
        if (hm) {
          closeUl(); closeTable();
          const lvl = hm[1].length;
          html += `<p class="ph${lvl}">${inlineMd(hm[2])}</p>`;
          continue;
        }

        /* Table row */
        if (/^\|/.test(trim)) {
          closeUl();
          /* separator row */
          if (/^\|[\s:\-|]+\|?$/.test(trim)) {
            if (!tablePassedHeader) {
              html += '</thead><tbody>';
              tablePassedHeader = true;
            }
            continue;
          }
          if (!inTable) {
            html += '<table class="md-table"><thead>';
            inTable = true;
          }
          const tag   = tablePassedHeader ? 'td' : 'th';
          const cells = trim.replace(/^\||\|$/g, '').split('|');
          html += '<tr>' + cells.map(c => `<${tag}>${inlineMd(c.trim())}</${tag}>`).join('') + '</tr>';
          continue;
        }

        /* Bullet list */
        if (/^[\*\-]\s+/.test(trim)) {
          closeTable();
          if (!inUl) { html += '<ul>'; inUl = true; }
          const content = trim.replace(/^[\*\-]\s+/, '');
          html += `<li>${inlineMd(content)}</li>`;
          continue;
        }

        /* Blank line */
        if (trim === '') {
          closeUl(); closeTable();
          continue;
        }

        /* Plain paragraph text */
        closeTable();
        /* continuation of a list item — append to last li */
        if (inUl && depth > 0) {
          html = html.slice(0, -5) + ' ' + inlineMd(trim) + '</li>';
        } else {
          closeUl();
          html += `<p>${inlineMd(trim)}</p>`;
        }
      }

      closeUl();
      closeTable();
      return html;
    }

    /* ── Error helpers ── */
    function showError(msg) { errorText.textContent = msg; errorEl.classList.add('visible'); }
    function clearError()   { errorEl.classList.remove('visible'); }

    /* ── Fetch ── */
    async function fetchData() {
      clearError();
      refreshBtn.disabled = true;
      refreshBtn.classList.add('spinning');

      const loading = '<tr class="empty-row"><td colspan="3">Loading&hellip;</td></tr>';
      gainersBody.innerHTML = loading;
      losersBody.innerHTML  = loading;
      marketAnalysis.innerHTML  = '<p class="prose-loading">Loading&hellip;</p>';
      portfolioEl.innerHTML     = '<p class="prose-loading">Loading&hellip;</p>';

      try {
        const res = await fetch(WEBHOOK, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status} – ${res.statusText}`);

        const json = await res.json();
        const data = Array.isArray(json) ? json[0] : json;
        if (!data) throw new Error('Unexpected response format from webhook.');

        /* As-of timestamp */
        asOfEl.textContent = 'As of ' + formatDate(data.asOf);

        /* Movers */
        gainersBody.innerHTML = buildMoverRows(data.gainers, true);
        losersBody.innerHTML  = buildMoverRows(data.losers,  false);

        /* Analysis — data.analysis is an array; use [0] */
        const analysis = Array.isArray(data.analysis) ? data.analysis[0] : data.analysis;
        marketAnalysis.innerHTML = renderMarkdown(analysis?.market    || '');
        portfolioEl.innerHTML    = renderMarkdown(analysis?.portfolio || '');

        nextRefresh = Date.now() + INTERVAL;

      } catch (err) {
        showError('Failed to load data: ' + err.message);
        const dash = '<tr class="empty-row"><td colspan="3">—</td></tr>';
        gainersBody.innerHTML = dash;
        losersBody.innerHTML  = dash;
        marketAnalysis.innerHTML = '<p class="prose-loading">Could not load analysis.</p>';
        portfolioEl.innerHTML    = '<p class="prose-loading">Could not load portfolio.</p>';
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.classList.remove('spinning');
      }
    }

    /* ── Countdown ── */
    function updateCountdown() {
      const rem = Math.max(0, nextRefresh - Date.now());
      const m = Math.floor(rem / 60000);
      const s = Math.floor((rem % 60000) / 1000);
      countdownEl.textContent = `Auto-refreshes in ${m}:${String(s).padStart(2, '0')}`;
    }

    refreshBtn.addEventListener('click', () => {
      nextRefresh = Date.now() + INTERVAL;
      fetchData();
    });

    fetchData();
    setInterval(fetchData, INTERVAL);
    updateCountdown();
    setInterval(updateCountdown, 1000);
  </script>
</body>
</html>
